#!/bin/bash

# ==============================================================================
# Скрипт сборки Hexlan-qt (x64 Windows) с выбором режима очистки
# ==============================================================================

# 1. Настройки путей
PROJECT_DIR="/mnt/hexlan3"
MXE_PATH="/mnt/mxe"
MXE_BIN="$MXE_PATH/usr/bin"
PRO_FILE="hexlan3WinLin.pro"

# Инструменты (x64)
QMAKE_TOOL="$MXE_BIN/x86_64-w64-mingw32.static-qmake-qt5"
LRELEASE_TOOL="$MXE_BIN/x86_64-w64-mingw32.static-lrelease"

# Переход в директорию проекта
cd "$PROJECT_DIR" || { echo "ОШИБКА: Не удалось перейти в $PROJECT_DIR"; exit 1; }

# Проверка наличия qmake
if [ ! -f "$QMAKE_TOOL" ]; then
    echo "ОШИБКА: qmake не найден по пути $QMAKE_TOOL"
    exit 1
fi

echo "================================================================"
echo "   СБОРКА HEXLAN-QT (Windows x64 Cross-Compile)"
echo "================================================================"

# ЭТАП 1: Обновление переводов
# Делаем это всегда, так как это быстро и критично для UI
echo "[1/4] Обновление языковых файлов (lrelease)..."
if [ -f "$LRELEASE_TOOL" ]; then
    "$LRELEASE_TOOL" "$PRO_FILE"
else
    echo "ПРЕДУПРЕЖДЕНИЕ: MXE lrelease не найден. Используем системный."
    lrelease "$PRO_FILE"
fi

# ЭТАП 2: Генерация Makefile
# Запускаем qmake всегда, чтобы убедиться, что Makefile соответствует .pro
echo "[2/4] Обновление Makefile (qmake)..."
"$QMAKE_TOOL" "$PRO_FILE"

if [ $? -ne 0 ]; then
    echo "ОШИБКА: qmake завершился неудачей."
    exit 1
fi

# ЭТАП 3: Интерактивный выбор очистки
echo "----------------------------------------------------------------"
echo "ВОПРОС: Выполнить полную очистку перед сборкой (make clean)?"
echo "   y - ДА. Удалить все объектные файлы. (Надежно, но долго)"
echo "   n - НЕТ. Использовать старые объектники. (Быстро)"
echo "----------------------------------------------------------------"
read -p "Ваш выбор [y/n]: " DO_CLEAN

if [[ "$DO_CLEAN" == "y" || "$DO_CLEAN" == "Y" ]]; then
    echo "[INFO] Выполняем make clean..."
    make clean
else
    echo "[INFO] Пропускаем очистку. Будут пересобраны только измененные файлы."
fi

# ЭТАП 4: Компиляция
# nice -n 19: минимальный приоритет процессора
# ionice -c 3: минимальный приоритет диска
# -j2: используем 2 потока
echo "[3/4] Запуск компиляции..."
nice -n 19 ionice -c 3 make -j2

# Проверка результата
if [ -f "release/Hexlan-qt.exe" ]; then
    echo "================================================================"
    echo "УСПЕХ! Сборка завершена."
    ls -lh release/Hexlan-qt.exe
    echo "================================================================"
else
    echo "================================================================"
    echo "ОШИБКА: Файл release/Hexlan-qt.exe не создан."
    echo "================================================================"
    exit 1
fi